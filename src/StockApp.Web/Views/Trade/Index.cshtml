@model StockApp.Models.StockTrade

@{
    ViewData["Title"] = "Trade";
    string? finnhubToken = ViewBag.FinnhubToken;
}

@{
    var symbols = new List<string> { Model.StockSymbol! };
    if (Model.StockSymbol != "GOOGL") symbols.Add("GOOGL");
}

@foreach (var symbol in symbols)
{
    bool isGoogl = symbol == "GOOGL";
    string name = isGoogl ? "Alphabet Inc." : Model.StockName!;
    double price = isGoogl ? 0 : Model.Price; // Will be updated by WS
    
    <div class="trade-container" style="margin-top: @(isGoogl ? "40px" : "0");">
        <div class="stock-info">
            <h1 class="stock-name">@name (@symbol)</h1>
            <div class="stock-price">
                <span class="currency">$</span>
                <span id="price-@symbol" class="price price-value">@price.ToString("F2")</span>
            </div>
            <div class="stock-price-label">Stock Price</div>
        </div>

        <div class="order-panel">
            <h3 class="order-title">New Order</h3>
            <div class="order-form">
                <label for="quantity-@symbol">Quantity:</label>
                <input type="number" id="quantity-@symbol" class="quantity-input" data-symbol="@symbol" min="1" max="100000" value="1" />
            </div>

            <div class="order-buttons">
                <form asp-controller="Trade" asp-action="SellOrder" method="post">
                    <input name="StockSymbol" type="hidden" value="@symbol" />
                    <input name="StockName" type="hidden" value="@name" />
                    <input name="Quantity" type="hidden" id="sell-qty-@symbol" value="1" />
                    <input name="Price" type="hidden" id="sell-price-@symbol" value="@price" />
                    <button type="submit" class="btn-sell">&#8595; Sell</button>
                </form>

                <form asp-controller="Trade" asp-action="BuyOrder" method="post">
                    <input name="StockSymbol" type="hidden" value="@symbol" />
                    <input name="StockName" type="hidden" value="@name" />
                    <input name="Quantity" type="hidden" id="buy-qty-@symbol" value="1" />
                    <input name="Price" type="hidden" id="buy-price-@symbol" value="@price" />
                    <button type="submit" class="btn-buy">&#8593; Buy</button>
                </form>
            </div>
        </div>

        <!-- START GRAPH PANEL -->
        <div class="graph-panel" style="flex: 2; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid #ddd; background-color: transparent;">
            <div class="timeframe-buttons" style="margin-bottom: 15px;">
                <button class="btn-timeframe btn-day" data-symbol="@symbol" style="padding: 6px 16px; margin: 0 5px; cursor: pointer; border: 1px solid #28a745; background: transparent; color: #28a745; border-radius: 4px; font-weight: bold;">Day</button>
                <button class="btn-timeframe btn-month" data-symbol="@symbol" style="padding: 6px 16px; margin: 0 5px; cursor: pointer; border: 1px solid #28a745; background: #28a745; color: white; border-radius: 4px; font-weight: bold;">Month</button>
                <button class="btn-timeframe btn-year" data-symbol="@symbol" style="padding: 6px 16px; margin: 0 5px; cursor: pointer; border: 1px solid #28a745; background: transparent; color: #28a745; border-radius: 4px; font-weight: bold;">Year</button>
            </div>
            <div style="width: 100%; height: 250px; position: relative;">
                <canvas id="chart-@symbol"></canvas>
            </div>
        </div>
        <!-- END GRAPH PANEL -->
    </div>
}

<input asp-for="StockSymbol" type="hidden" id="stock-symbol" />
<input type="hidden" id="finnhub-token" value="@finnhubToken" />

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const token = document.getElementById("finnhub-token").value;
    const stockCharts = {};
    const stockPrices = {};
    let socket = null;

    class StockTrader {
        constructor(symbol) {
            this.symbol = symbol;
            this.priceElement = document.getElementById(`price-${symbol}`);
            this.buyPriceInput = document.getElementById(`buy-price-${symbol}`);
            this.sellPriceInput = document.getElementById(`sell-price-${symbol}`);
            this.qtyInput = document.getElementById(`quantity-${symbol}`);
            this.buyQtyInput = document.getElementById(`buy-qty-${symbol}`);
            this.sellQtyInput = document.getElementById(`sell-qty-${symbol}`);
            this.chartCtx = document.getElementById(`chart-${symbol}`).getContext('2d');
            this.chart = null;
            this.currentPrice = 0;

            this.init();
        }

        init() {
            // Quantity Listeners
            const updateQty = (val) => {
                this.buyQtyInput.value = val;
                this.sellQtyInput.value = val;
            };

            this.qtyInput.addEventListener("input", (e) => updateQty(e.target.value));
            this.qtyInput.addEventListener("change", (e) => updateQty(e.target.value));

            // Timeframe Listeners
            const container = this.qtyInput.closest('.trade-container');
            container.querySelectorAll('.btn-timeframe').forEach(btn => {
                btn.addEventListener('click', () => {
                    const timeframe = btn.classList.contains('btn-day') ? 'day' :
                                    btn.classList.contains('btn-month') ? 'month' : 'year';
                    this.fetchAndRenderChart(timeframe, btn);
                });
            });

            // Initial Chart
            this.fetchAndRenderChart('month', container.querySelector('.btn-month'));
        }

        updatePrice(price) {
            this.currentPrice = price;
            this.priceElement.textContent = price.toFixed(2);
            this.buyPriceInput.value = price.toFixed(2);
            this.sellPriceInput.value = price.toFixed(2);
        }

        async fetchAndRenderChart(timeframe, btn) {
            if (!token || !this.symbol) return;

            // Update UI buttons
            const buttons = btn.parentElement.querySelectorAll('.btn-timeframe');
            buttons.forEach(b => {
                b.style.background = 'transparent';
                b.style.color = '#28a745';
            });
            btn.style.background = '#28a745';
            btn.style.color = 'white';

            try {
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${this.symbol}&token=${token}`);
                const data = await response.json();

                if (data.c !== undefined) {
                    const price = data.c;
                    this.updatePrice(price);
                    
                    const labels = [];
                    const prices = [];
                    const now = new Date();
                    let pointsCount = timeframe === 'day' ? 24 : timeframe === 'month' ? 30 : 52;
                    let volatility = price * (timeframe === 'day' ? 0.005 : timeframe === 'month' ? 0.015 : 0.05);

                    let simulatedPrice = price;
                    for (let i = pointsCount - 1; i >= 0; i--) {
                        prices.unshift(simulatedPrice);
                        const date = new Date(now);
                        if (timeframe === 'day') {
                            date.setHours(now.getHours() - i);
                            labels.unshift(date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                        } else if (timeframe === 'month') {
                            date.setDate(now.getDate() - i);
                            labels.unshift(date.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                        } else {
                            date.setDate(now.getDate() - (i * 7));
                            labels.unshift(date.toLocaleDateString([], { month: 'short', year: 'numeric' }));
                        }
                        simulatedPrice = Math.max(0.01, simulatedPrice - (Math.random() - 0.5) * volatility);
                    }

                    this.renderChart(labels, prices, timeframe);
                }
            } catch (e) { console.error("Chart Error:", e); }
        }

        renderChart(labels, data, timeframe) {
            if (this.chart) this.chart.destroy();
            this.chart = new Chart(this.chartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${this.symbol} Price`,
                        data: data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: timeframe === 'year' ? 1 : 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } },
                        y: { ticks: { callback: v => '$' + v } }
                    }
                }
            });
        }
    }

    // Initialize all traders
    const traders = {};
    document.querySelectorAll('.quantity-input').forEach(input => {
        const symbol = input.dataset.symbol;
        traders[symbol] = new StockTrader(symbol);
    });

    // Shared WebSocket
    if (token) {
        socket = new WebSocket(`wss://ws.finnhub.io?token=${token}`);
        socket.addEventListener("open", () => {
            Object.keys(traders).forEach(symbol => {
                socket.send(JSON.stringify({ type: "subscribe", symbol }));
            });
        });

        socket.addEventListener("message", (event) => {
            const message = JSON.parse(event.data);
            if (message.type === "trade") {
                message.data.forEach(trade => {
                    const trader = traders[trade.s];
                    if (trader) trader.updatePrice(trade.p);
                });
            }
        });
    }

    window.addEventListener("beforeunload", () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            Object.keys(traders).forEach(s => socket.send(JSON.stringify({ type: "unsubscribe", symbol: s })));
            socket.close();
        }
    });
</script>
}
